{% extends "wildlife/base.html" %}

{% block title %}Edit Photo{% endblock %}

{% block content %}
  <h1>Edit Photo</h1>

  <div style="display:flex; gap:20px; align-items:flex-start;">

    <!-- LEFT COLUMN: IMAGE + OPTIONAL BOUNDING BOXES -->
    <div>
      {% if photo.image %}
        <div class="photo-wrapper" id="photo-wrapper">
          <img src="{{ photo.image.url }}" alt="photo {{ photo.id }}"
            style="display:block; max-width:560px; width:100%; height:auto; border-radius:8px;">

          {% if has_detections %}
            {% for box in detection_boxes %}
              <div class="det-box"
                   style="
                     left: {{ box.left }}%;
                     top: {{ box.top }}%;
                     width: {{ box.width }}%;
                     height: {{ box.height }}%;
                   ">
                <div class="det-label">
                  {{ box.label }} ({{ box.confidence|floatformat:2 }})
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>
      {% endif %}
    </div>

    <!-- RIGHT COLUMN: FORM + ACTIONS + AI SUMMARY -->
    <div style="flex:1;">

      <!-- PHOTO EDIT FORM -->
      <form method="post">
        {% csrf_token %}
        <table>
          {{ form.as_table }}
        </table>

        <div style="margin-top:12px;">
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>

      <!-- ACTION BUTTONS -->
      <div style="margin-top:18px; display:flex; gap:8px; align-items:center;">
        <form method="post" action="{% url 'wildlife:analyze_photo' photo.id %}">
          {% csrf_token %}
          <button class="btn" type="submit">Analyze (OCR + AI)</button>
        </form>

        {% if photo.date_taken and photo.time_taken and photo.temperature is not None and photo.pressure is not None %}
          <form method="post" action="{% url 'wildlife:publish_photo' photo.id %}">
            {% csrf_token %}
            <button class="btn btn-primary" type="submit">Publish</button>
          </form>
        {% endif %}

        <form method="post" action="{% url 'wildlife:delete_photo_staging' photo.id %}">
          {% csrf_token %}
          <button class="btn"
                  type="submit"
                  onclick="return confirm('Delete this unpublished photo? This cannot be undone.');">
            Delete
          </button>
        </form>

        {% if has_detections %}
          <button class="btn" id="toggle-boxes-btn" type="button">
            Show bounding boxes
          </button>
        {% endif %}
      </div>

      <!-- AI DETECTION SUMMARY -->
      <div style="margin-top:20px;">
        {% if has_detections %}
          <p><strong>AI detections:</strong>
            {% if num_animals %}
              {{ num_animals }} animal{% if num_animals != 1 %}s{% endif %}
            {% endif %}

            {% if num_people %}
              {% if num_animals %}, {% endif %}
              {{ num_people }} person{% if num_people != 1 %}s{% endif %}
            {% endif %}

            {% if num_vehicles %}
              {% if num_animals or num_people %}, {% endif %}
              {{ num_vehicles }} vehicle{% if num_vehicles != 1 %}s{% endif %}
            {% endif %}
            .
          </p>
        {% else %}
          <p><em>No AI detections yet. Click “Analyze (OCR + AI)” to run detection.</em></p>
        {% endif %}
      </div>

    </div>
  </div>

  {% if has_detections %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const wrapper = document.getElementById('photo-wrapper');
        const btn = document.getElementById('toggle-boxes-btn');
        if (!wrapper || !btn) return;

        btn.addEventListener('click', function () {
          const showing = wrapper.classList.toggle('show-boxes');
          btn.textContent = showing ? 'Hide bounding boxes' : 'Show bounding boxes';
        });
      });
    </script>
  {% endif %}
{% endblock %}
