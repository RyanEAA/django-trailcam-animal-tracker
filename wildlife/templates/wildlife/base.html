<!DOCTYPE html>
<html>
<head>
  <title>{% block title %}Trailcam Wildlife{% endblock %}</title>

  {% load static %}
  <link rel="stylesheet" href="{% static 'wildlife/styles.css' %}">

  {% block extra_head %}{% endblock %}
</head>

<body>
  <nav class="nav">
    <div class="nav-left">
      <a class="nav-link" href="{% url 'wildlife:gallery' %}">Gallery</a>

      {% if user.is_authenticated and user.is_researcher %}
        <a class="nav-link" href="{% url 'wildlife:upload_photos' %}">Upload Photos</a>
      {% endif %}
    </div>

    <div class="nav-right">
      {% if user.is_authenticated %}
        <span class="nav-greeting">Hello, {{ user.username }}!</span>
        <form class="nav-form" action="{% url 'logout' %}" method="post">
          {% csrf_token %}
          <button class="btn btn-danger" type="submit">Sign Out</button>
        </form>
      {% else %}
        <a class="nav-link" href="{% url 'login' %}?next={% url 'wildlife:gallery' %}">Sign In</a>
      {% endif %}
    </div>
  </nav>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <!-- ✅ Single modal -->
  <div id="cardModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button id="modalCloseBtn" class="modal-close" type="button" aria-label="Close">×</button>

      <!-- toast (hidden by default) -->
      <div id="modalToast" class="toast" role="status" aria-live="polite"></div>

      <div id="cardModalContent"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById("cardModal");
      const modalContent = document.getElementById("cardModalContent");
      const closeBtn = document.getElementById("modalCloseBtn");
      const toast = document.getElementById("modalToast");

      function getCSRFToken() {
        const name = "csrftoken=";
        return document.cookie.split(";").map(s => s.trim())
          .find(s => s.startsWith(name))?.slice(name.length) || "";
      }

      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add("is-showing");
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(() => toast.classList.remove("is-showing"), 1200);
      }

      function openModal() {
        modal.classList.add("is-open");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        modal.classList.remove("is-open");
        modal.setAttribute("aria-hidden", "true");
        modalContent.innerHTML = "";
      }

      closeBtn.addEventListener("click", closeModal);

      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.classList.contains("is-open")) closeModal();
      });

      function renderModalFromCard(card) {
        const id = card.dataset.photoId;
        const img = card.querySelector("img")?.getAttribute("src") || "";
        const title = card.querySelector(".photo-title")?.textContent?.trim() || "Photo";

        const camera = card.dataset.camera || "";
        const date = card.dataset.date || "";
        const time = card.dataset.time || "";
        const temp = card.dataset.temp || "";
        const press = card.dataset.press || "";

        modalContent.innerHTML = `
          <h2 id="modalTitle" class="modal-title">${title}</h2>

          <div class="modal-grid">
            <div>
              <img class="modal-image" src="${img}" alt="photo ${id}">
            </div>

            <div>
              <form class="meta-form" id="metaForm">
                <div class="meta-error" id="metaError"></div>

                <label>Camera (TRAILCAM05)</label>
                <input name="camera_name" type="text" value="${camera}" placeholder="TRAILCAM05" autocomplete="off">

                <label>Date</label>
                <input name="date_taken" type="date" value="${date}">

                <label>Time</label>
                <input name="time_taken" type="time" value="${time}">

                <label>Temperature (°C)</label>
                <input name="temperature" type="number" step="0.1" min="-60" max="80" value="${temp}" placeholder="e.g. 23.0">

                <label>Pressure (inHg)</label>
                <input name="pressure" type="number" step="0.01" min="20" max="35" value="${press}" placeholder="e.g. 29.09">

                <div class="meta-row-actions">
                  <button id="saveBtn" class="btn btn-primary" type="button" style="display:none;">Save</button>

                  <form method="post" action="/photo/${id}/delete-staging/" class="inline-form">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${getCSRFToken()}">
                    <button class="btn" type="submit"
                      onclick="event.stopPropagation(); return confirm('Delete this unpublished photo? This cannot be undone.');">
                      Delete
                    </button>
                  </form>
                </div>
              </form>
            </div>
          </div>
        `;

        const form = modalContent.querySelector("#metaForm");
        const saveBtn = modalContent.querySelector("#saveBtn");
        const errBox = modalContent.querySelector("#metaError");

        const baseline = Object.fromEntries(new FormData(form).entries());

        function setError(msg) {
          errBox.textContent = msg || "";
          errBox.style.display = msg ? "block" : "none";
        }
        setError("");

        // normalize camera input
        form.querySelector('input[name="camera_name"]').addEventListener("input", (e) => {
          e.target.value = e.target.value.toUpperCase().replace(/\s+/g, "");
        });

        // show save when dirty
        form.addEventListener("input", () => {
          const now = Object.fromEntries(new FormData(form).entries());
          const dirty = Object.keys(now).some(k => (now[k] || "") !== (baseline[k] || ""));
          saveBtn.style.display = dirty ? "inline-block" : "none";
          setError("");
        });

        saveBtn.addEventListener("click", async () => {
          saveBtn.disabled = true;
          setError("");

          try {
            const payload = new URLSearchParams();
            for (const [k, v] of new FormData(form).entries()) payload.set(k, v);

            const res = await fetch(`/photo/${id}/meta/update/`, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCSRFToken(),
              },
              body: payload.toString(),
            });

            const data = await res.json();

            if (!data.ok) {
              const msg = data.errors
                ? Object.entries(data.errors).map(([k, v]) => `${k}: ${v}`).join("\n")
                : (data.error || "Save failed.");
              setError(msg);
              return;
            }

            // update card dataset (so page stays in sync)
            const updated = data.photo;
            const pageCard = document.querySelector(`.photo-card[data-photo-id="${id}"]`);
            if (pageCard) {
              pageCard.dataset.camera = updated.camera_name || "";
              pageCard.dataset.date = updated.date_taken || "";
              pageCard.dataset.time = updated.time_taken || "";
              pageCard.dataset.temp = updated.temperature || "";
              pageCard.dataset.press = updated.pressure || "";
            }

            showToast("Saved ✓");

            // close after a short beat so user sees the toast
            setTimeout(() => closeModal(), 450);

          } catch (e) {
            setError("Save failed. Check server logs.");
          } finally {
            saveBtn.disabled = false;
          }
        });

        openModal();
      }

      // Click card -> open modal (only /upload)
      document.addEventListener("click", (e) => {
        const card = e.target.closest(".photo-card.is-clickable");
        if (!card) return;
        if (e.target.closest("button, form, a, input, select, textarea")) return;
        if (!location.pathname.startsWith("/upload")) return;
        renderModalFromCard(card);
      });
    });
  </script>
</body>
</html>
