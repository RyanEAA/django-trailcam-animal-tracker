{% extends "wildlife/base.html" %}

{% block title %}Gallery{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  .split-container {
    display: flex;
    height: calc(100vh - 200px);
    min-height: 600px;
    gap: 0;
    position: relative;
  }
  
  .photo-card.highlighted {
    outline: 3px solid #007bff;
    outline-offset: 2px;
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
    transition: all 0.3s ease;
  }
  
  .map-panel {
    flex: 0 0 40%;
    min-width: 200px;
    position: relative;
    overflow: hidden;
  }
  
  #map {
    width: 100%;
    height: 100%;
  }
  
  .divider {
    flex: 0 0 4px;
    background: #ddd;
    cursor: col-resize;
    position: relative;
    transition: background 0.2s;
  }
  
  .divider:hover {
    background: #999;
  }
  
  .divider::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 40px;
    background: inherit;
    border-radius: 10px;
  }
  
  .gallery-panel {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px;
  }
  
  .filter-section {
    margin-bottom: 20px;
  }
</style>

<h1>Public Gallery</h1>

<!-- FILTER SECTION -->
<div class="filter-section" style="background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:20px;">
  <h3 style="margin-top:0; margin-bottom:12px;">Filters</h3>
  
  <form method="get" action="{% url 'wildlife:gallery' %}" style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end;">
    
    <!-- Camera Filter -->
    <div>
      <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.9em;">Camera</label>
      <select name="camera" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px;">
        <option value="">All cameras</option>
        {% for camera in camera_options %}
          <option value="{{ camera.id }}" {% if camera.id|stringformat:"s" == selected_camera_id %}selected{% endif %}>
            {{ camera.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Date Range Filter -->
    <div>
      <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.9em;">Start Date</label>
      <input type="date" name="start_date" value="{{ start_date }}" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px;">
    </div>

    <div>
      <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.9em;">End Date</label>
      <input type="date" name="end_date" value="{{ end_date }}" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px;">
    </div>

    <!-- Temperature Range Filter -->
    <div>
      <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.9em;">Min Temp (°C)</label>
      <input type="number" name="temp_min" value="{{ temp_min }}" step="0.1" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px; width:100px;">
    </div>

    <div>
      <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.9em;">Max Temp (°C)</label>
      <input type="number" name="temp_max" value="{{ temp_max }}" step="0.1" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px; width:100px;">
    </div>

    <!-- Pressure Range Filter -->
    <div>
      <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.9em;">Min Pressure (inHg)</label>
      <input type="number" name="pressure_min" value="{{ pressure_min }}" step="0.01" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px; width:100px;">
    </div>

    <div>
      <label style="display:block; margin-bottom:4px; font-weight:600; font-size:0.9em;">Max Pressure (inHg)</label>
      <input type="number" name="pressure_max" value="{{ pressure_max }}" step="0.01" style="padding:6px 8px; border:1px solid #ccc; border-radius:4px; width:100px;">
    </div>

    <button type="submit" class="btn btn-primary" style="margin-top:22px;">Apply Filters</button>
    <a href="{% url 'wildlife:gallery' %}" class="btn btn-secondary" style="margin-top:22px;">Clear Filters</a>
  </form>

  <!-- Species Filter (Checkboxes) -->
  {% if species_options %}
    <div style="margin-top:12px;">
      <div style="font-weight:600; font-size:0.9em; margin-bottom:8px;">Species</div>
      <form method="get" action="{% url 'wildlife:gallery' %}" style="display:flex; flex-wrap:wrap; gap:12px; padding:8px 0;">
        <!-- Hidden inputs to preserve other filters -->
        <input type="hidden" name="camera" value="{{ selected_camera_id }}">
        <input type="hidden" name="start_date" value="{{ start_date }}">
        <input type="hidden" name="end_date" value="{{ end_date }}">
        <input type="hidden" name="temp_min" value="{{ temp_min }}">
        <input type="hidden" name="temp_max" value="{{ temp_max }}">
        <input type="hidden" name="pressure_min" value="{{ pressure_min }}">
        <input type="hidden" name="pressure_max" value="{{ pressure_max }}">

        {% for species in species_options %}
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" name="species" value="{{ species.id }}" 
              {% if species.id|stringformat:"s" in selected_species_ids %}checked{% endif %}
              onchange="this.form.submit();">
            {{ species.name }}
          </label>
        {% endfor %}
      </form>
    </div>
  {% endif %}
</div>

<div style="margin: 10px 0 18px 0;">
  <button id="toggle-params-btn" class="btn" type="button">
    Hide details
  </button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("toggle-params-btn");
    const body = document.body;

    const hideParams = localStorage.getItem("hidePhotoParams") === "true";
    if (hideParams) {
      body.classList.add("hide-params");
      btn.textContent = "Show details";
    }

    btn.addEventListener("click", () => {
      body.classList.toggle("hide-params");
      const isHidden = body.classList.contains("hide-params");
      btn.textContent = isHidden ? "Show details" : "Hide details";
      localStorage.setItem("hidePhotoParams", isHidden);
    });
  });
</script>

<!-- Split container with map and gallery -->
<div class="split-container">
  <!-- Gallery Panel -->
  <div class="gallery-panel">
    {% if photos_with_boxes %}
      <div style="display:flex; flex-wrap:wrap; gap:16px;">
        {% for item in photos_with_boxes %}
          {% with photo=item.photo %}
          <div class="photo-card is-clickable"
               data-photo-id="{{ photo.id }}"
               data-edit-url="{% url 'wildlife:photo_detail' photo.id %}">
            <div class="photo-title">
              {{ photo.image.name|default:"Photo" }}
            </div>

            {% if photo.image %}
              <div class="photo-wrapper show-boxes">
                <img src="{{ photo.image.url }}" class="photo-zoom" alt="photo {{ photo.id }}">
                {% for box in item.detection_boxes %}
                  <div class="det-box{% if box.is_person %} det-box-person{% endif %}"
                       style="
                         left: {{ box.left }}%;
                         top: {{ box.top }}%;
                         width: {{ box.width }}%;
                         height: {{ box.height }}%;
                       ">
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="photo-params">
              <strong>Model parameters:</strong>
              <ul>
                <li>Camera ID:
                  {% if photo.camera %}
                    {{ photo.camera.name }}
                  {% else %}
                    Unknown
                  {% endif %}
                </li>

                <li>Date/time:
                  {% if photo.date_taken %}
                    {{ photo.date_taken }}{% if photo.time_taken %} {{ photo.time_taken }}{% endif %}
                  {% else %}
                    {{ photo.uploaded_at }}
                  {% endif %}
                </li>

                <li>Temperature:
                  {% if photo.temperature %}
                    {{ photo.temperature }}&deg;C
                  {% else %}
                    —
                  {% endif %}
                </li>
                <li>Pressure:
                  {% if photo.pressure %}
                    {{ photo.pressure }} inHg
                  {% else %}
                    —
                  {% endif %}
                </li>
              </ul>
            </div>

            {# Unpublish handled on the card detail page for researchers. #}
          </div>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <p>No photos yet.</p>
    {% endif %}
  </div>
  
  <!-- Resizable Divider -->
  <div class="divider" id="divider"></div>
  
  <!-- Map Panel -->
  <div class="map-panel">
    <div id="map"></div>
  </div>
</div>

<script>
  // Initialize map
  var map = L.map('map').setView([30.2672, -97.7431], 10); // Default Austin, TX
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19
  }).addTo(map);
  
  // Add markers for photos
  var photoLocations = {{ photo_locations|safe }};
  
  if (photoLocations && photoLocations.length > 0) {
    var bounds = [];
    
    photoLocations.forEach(function(location) {
      var marker = L.marker([location.lat, location.lng]).addTo(map);
      
      marker.bindPopup(
        '<strong>Camera:</strong> ' + location.camera + '<br>' +
        '<strong>Date:</strong> ' + location.date
      );
      
      // Highlight photo card when marker is clicked
      marker.on('click', function() {
        // Remove previous highlights
        document.querySelectorAll('.photo-card.highlighted').forEach(function(card) {
          card.classList.remove('highlighted');
        });
        
        // Find and highlight the corresponding photo card
        var photoCard = document.querySelector('.photo-card[data-photo-id="' + location.id + '"]');
        if (photoCard) {
          photoCard.classList.add('highlighted');
          // Scroll to the photo card
          photoCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
      
      bounds.push([location.lat, location.lng]);
    });
    
    // Fit map to show all markers
    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }
  
  // Resizable divider functionality
  var divider = document.getElementById('divider');
  var mapPanel = document.querySelector('.map-panel');
  var container = document.querySelector('.split-container');
  var isResizing = false;
  
  divider.addEventListener('mousedown', function(e) {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  });
  
  document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    
    var containerRect = container.getBoundingClientRect();
    var newWidth = e.clientX - containerRect.left;
    var percentage = (newWidth / containerRect.width) * 100;
    
    // Keep between 20% and 80%
    if (percentage >= 20 && percentage <= 80) {
      // Map is on the right, so invert the percentage
      mapPanel.style.flex = '0 0 ' + (100 - percentage) + '%';
      map.invalidateSize(); // Refresh map after resize
    }
  });
  
  document.addEventListener('mouseup', function() {
    if (isResizing) {
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });
  
  // Ensure map renders properly after page load
  setTimeout(function() {
    map.invalidateSize();
  }, 100);
</script>

{% endblock %}
