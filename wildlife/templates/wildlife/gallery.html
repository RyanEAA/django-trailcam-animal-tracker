{% extends "wildlife/base.html" %}

{% block title %}Gallery{% endblock %}

{% block content %}
<h1>Public Gallery</h1>

<div style="margin: 10px 0 18px 0;">
  <button id="toggle-params-btn" class="btn" type="button">
    Hide details
  </button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("toggle-params-btn");
    const body = document.body;

    const hideParams = localStorage.getItem("hidePhotoParams") === "true";
    if (hideParams) {
      body.classList.add("hide-params");
      btn.textContent = "Show details";
    }

    btn.addEventListener("click", () => {
      body.classList.toggle("hide-params");
      const isHidden = body.classList.contains("hide-params");
      btn.textContent = isHidden ? "Show details" : "Hide details";
      localStorage.setItem("hidePhotoParams", isHidden);
    });
  });
</script>

{% if photos %}
  <div style="display:flex; flex-wrap:wrap; gap:16px;">
    {% for photo in photos %}
      <div class="photo-card is-clickable"
           {% if user.is_authenticated and user.is_researcher and not photo.is_published %}
             data-edit-url="{% url 'wildlife:photo_edit' photo.id %}"
           {% elif user.is_authenticated and user.is_researcher and photo.is_published %}
             data-edit-url="{% url 'wildlife:photo_edit' photo.id %}"
           {% else %}
             data-edit-url="{% url 'wildlife:photo_detail' photo.id %}"
           {% endif %}>
        <div class="photo-title">
          {{ photo.image.name|default:"Photo" }}
        </div>

        {% if photo.image %}
          <img src="{{ photo.image.url }}" class="photo-zoom" alt="photo {{ photo.id }}">
        {% endif %}

        <div class="photo-params">
          <strong>Model parameters:</strong>
          <ul>
            <li>Species: {{ photo.species.name|default:"Unknown" }}</li>
            <li>Date/time:
              {% if photo.date_taken %}
                {{ photo.date_taken }}{% if photo.time_taken %} {{ photo.time_taken }}{% endif %}
              {% else %}
                {{ photo.uploaded_at }}
              {% endif %}
            </li>
            <li>Camera ID:
              {% if photo.camera %}
                {{ photo.camera.name }}
              {% else %}
                Unknown
              {% endif %}
            </li>
            <li>Temperature:
              {% if photo.temperature %}
                {{ photo.temperature }}&deg;C
              {% else %}
                —
              {% endif %}
            </li>
            <li>Pressure:
              {% if photo.pressure %}
                {{ photo.pressure }} inHg
              {% else %}
                —
              {% endif %}
            </li>
          </ul>
        </div>

        {% if user.is_authenticated and user.is_researcher %}
          <div class="card-actions">
            <form method="post"
                  action="{% url 'wildlife:unpublish_photo' photo.id %}">
              {% csrf_token %}
              <button class="btn"
                      type="submit"
                      onclick="event.stopPropagation(); return confirm('Unpublish this photo and move it back to staging?');">
                Unpublish
              </button>
            </form>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No photos yet.</p>
{% endif %}
{% endblock %}
