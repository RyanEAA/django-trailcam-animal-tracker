{% extends "wildlife/base.html" %}

{% block title %}Upload Photos{% endblock %}

{% block content %}
<h1>Upload Trailcam Photos</h1>

<p><a href="{% url 'wildlife:gallery' %}">&larr; Back to Gallery</a></p>

{% if error %}
  <div style="background:#ffecec; border:1px solid #f5aca6; padding:8px; margin-bottom:10px; border-radius:4px;">
    {{ error }}
  </div>
{% endif %}

<form id="upload-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <!-- Hidden file input (name MUST be "images") -->
  <input id="file-input" type="file" name="images" multiple accept="image/*" style="display:none;">

  <!-- Dropzone -->
  <div id="dropzone"
       style="border: 2px dashed #ccc; border-radius: 8px; padding: 40px;
              text-align: center; cursor:pointer; max-width:600px;">
    <p style="margin:0;">Drag &amp; drop images here, or click to select files.</p>
  </div>

  <!-- Selected files cards -->
  <div id="file-info" style="margin-top:16px; display:none;">
    <strong>Selected files:</strong>
    <div id="file-previews"
         style="margin-top:8px; display:flex; flex-wrap:wrap; gap:12px;"></div>
  </div>

  <p style="margin-top:16px;">
    <button id="upload-btn" type="submit" disabled>Upload Photos</button>
  </p>
</form>

<hr style="margin: 28px 0;">

<h2>Your uploaded photos</h2>
<p style="color:#666;">
  Click <strong>Analyze</strong> to extract metadata. Then <strong>Publish</strong> to show in the gallery.
</p>

<table style="width:100%; border-collapse:collapse; margin-top:12px;">
  <thead>
    <tr>
      <th style="text-align:left;">Preview</th>
      <th>Camera</th>
      <th>Date</th>
      <th>Time</th>
      <th>Temp</th>
      <th>Pressure</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for photo in recent_photos %}
    <tr style="border-top:1px solid #ddd;">
      <td style="padding:8px;">
        <img src="{{ photo.image.url }}" style="max-width:120px;">
      </td>
      <td>{{ photo.camera.name|default:"—" }}</td>
      <td>{{ photo.date_taken|default:"—" }}</td>
      <td>{{ photo.time_taken|default:"—" }}</td>
      <td>
        {% if photo.temperature is not None %}
          {{ photo.temperature }}°C
        {% else %}
          —
        {% endif %}
      </td>
      <td>
        {% if photo.pressure is not None %}
          {{ photo.pressure }} inHg
        {% else %}
          —
        {% endif %}
      </td>
      <td>
        {% if photo.is_published %}
          Published
        {% elif photo.date_taken %}
          Analyzed
        {% else %}
          Uploaded
        {% endif %}
      </td>
      <td>
        <!-- ANALYZE -->
        <form method="post"
              action="{% url 'wildlife:analyze_photo' photo.id %}"
              style="display:inline;">
          {% csrf_token %}
          <button type="submit">Analyze</button>
        </form>

        <!-- PUBLISH -->
        {% if photo.date_taken and photo.time_taken and photo.temperature is not None and photo.pressure is not None and not photo.is_published %}
          <form method="post"
                action="{% url 'wildlife:publish_photo' photo.id %}"
                style="display:inline;">
            {% csrf_token %}
            <button type="submit">Publish</button>
          </form>
        {% endif %}
      </td>
    </tr>
  {% empty %}
    <tr>
      <td colspan="8">No uploads yet.</td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('file-input');
  const fileInfo = document.getElementById('file-info');
  const filePreviews = document.getElementById('file-previews');
  const uploadBtn = document.getElementById('upload-btn');

  function createPreviewCardForFile(file) {
    const card = document.createElement('div');
    card.style.border = '1px solid #ddd';
    card.style.borderRadius = '8px';
    card.style.padding = '10px';
    card.style.width = '240px';

    const title = document.createElement('div');
    title.textContent = file.name;
    title.style.fontWeight = '600';
    title.style.marginBottom = '8px';
    title.style.wordBreak = 'break-word';

    const img = document.createElement('img');
    img.alt = file.name;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.borderRadius = '6px';
    img.style.display = 'block';

    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.readAsDataURL(file);
    } else {
      img.style.display = 'none';
    }

    card.appendChild(title);
    card.appendChild(img);
    return card;
  }

  function updateFileInfo() {
    const files = fileInput.files;
    const hasFiles = files && files.length > 0;

    fileInfo.style.display = hasFiles ? 'block' : 'none';
    uploadBtn.disabled = !hasFiles;

    filePreviews.innerHTML = '';
    if (!hasFiles) return;

    Array.from(files).forEach(file => {
      filePreviews.appendChild(createPreviewCardForFile(file));
    });
  }

  dropzone.addEventListener('click', () => fileInput.click());

  ['dragenter', 'dragover'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = '#4285f4';
      dropzone.style.background = '#f1f5ff';
    });
  });

  ['dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = '#ccc';
      dropzone.style.background = 'transparent';
    });
  });

  dropzone.addEventListener('drop', e => {
    const dt = new DataTransfer();
    for (const file of e.dataTransfer.files) dt.items.add(file);
    fileInput.files = dt.files;
    updateFileInfo();
  });

  fileInput.addEventListener('change', updateFileInfo);
</script>
{% endblock %}
