{% extends "wildlife/base.html" %}

{% block title %}Upload Photos{% endblock %}

{% block content %}
<h1>Upload Trailcam Photos</h1>

<p><a href="{% url 'wildlife:gallery' %}">&larr; Back to Gallery</a></p>

<div style="margin: 10px 0 18px 0;">
  <button id="toggle-params-btn" class="btn" type="button">
    Hide details
  </button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("toggle-params-btn");
    const body = document.body;

    const hideParams = localStorage.getItem("hidePhotoParams") === "true";
    if (hideParams) {
      body.classList.add("hide-params");
      btn.textContent = "Show details";
    }

    btn.addEventListener("click", () => {
      body.classList.toggle("hide-params");
      const isHidden = body.classList.contains("hide-params");
      btn.textContent = isHidden ? "Show details" : "Hide details";
      localStorage.setItem("hidePhotoParams", isHidden);
    });
  });
</script>

{% if error %}
  <div style="background:#ffecec; border:1px solid #f5aca6; padding:8px; margin-bottom:10px; border-radius:6px;">
    {{ error }}
  </div>
{% endif %}

<form id="upload-form" method="post" enctype="multipart/form-data" style="margin-bottom:18px;">
  {% csrf_token %}

  <input id="file-input" type="file" name="images" multiple accept="image/*" style="display:none;">

  <div id="dropzone"
       style="border: 2px dashed #ccc; border-radius: 10px; padding: 34px;
              text-align: center; cursor:pointer; max-width:760px;">
    <p style="margin:0;">Drag &amp; drop images here, or click to select files.</p>
  </div>

  <div id="file-info" style="margin-top:16px; display:none;">
    <strong>Selected files:</strong>
    <div id="file-previews"
         style="margin-top:10px; display:flex; flex-wrap:wrap; gap:12px;"></div>
  </div>

  <p style="margin-top:16px;">
    <button id="upload-btn" class="btn btn-primary" type="submit" disabled>Upload Photos</button>
  </p>
</form>

<script>
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('file-input');
  const fileInfo = document.getElementById('file-info');
  const filePreviews = document.getElementById('file-previews');
  const uploadBtn = document.getElementById('upload-btn');

  function createPreviewCardForFile(file) {
    const card = document.createElement('div');
    card.className = 'photo-card';

    const title = document.createElement('div');
    title.className = 'photo-title';
    title.textContent = file.name;

    const img = document.createElement('img');
    img.alt = file.name;

    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.readAsDataURL(file);
    } else {
      img.style.display = 'none';
    }

    const params = document.createElement('div');
    params.className = 'photo-params';
    params.innerHTML = `
      <strong>Model parameters:</strong>
      <ul>
        <li>Species: to be inferred</li>
        <li>Date/time: to be inferred</li>
        <li>Camera ID: to be inferred</li>
        <li>Temperature: to be inferred</li>
        <li>Pressure: to be inferred</li>
      </ul>
    `;

    card.appendChild(title);
    card.appendChild(img);
    card.appendChild(params);
    return card;
  }

  function updateFileInfo() {
    const files = fileInput.files;
    const hasFiles = files && files.length > 0;

    fileInfo.style.display = hasFiles ? 'block' : 'none';
    uploadBtn.disabled = !hasFiles;

    filePreviews.innerHTML = '';
    if (!hasFiles) return;

    Array.from(files).forEach(file => {
      filePreviews.appendChild(createPreviewCardForFile(file));
    });
  }

  dropzone.addEventListener('click', () => fileInput.click());

  ['dragenter', 'dragover'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = '#2c6bed';
      dropzone.style.background = '#f1f5ff';
    });
  });

  ['dragleave', 'drop'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.style.borderColor = '#ccc';
      dropzone.style.background = 'transparent';
    });
  });

  dropzone.addEventListener('drop', e => {
    const dt = new DataTransfer();
    for (const file of e.dataTransfer.files) dt.items.add(file);
    fileInput.files = dt.files;
    updateFileInfo();
  });

  fileInput.addEventListener('change', updateFileInfo);
</script>

<hr style="margin: 26px 0;">

<h2>Your uploaded photos</h2>
<p style="color:#666; margin-top:6px;">
  Click a card to open it. Analyze first, then publish.
</p>

{% if recent_photos %}
  <div style="display:flex; flex-wrap:wrap; gap:16px; margin-top:16px;">
    {% for photo in recent_photos %}
      <div class="photo-card is-clickable">
        <div class="photo-title">
          {{ photo.image.name|default:"Photo" }}
        </div>

        {% if photo.image %}
          <img src="{{ photo.image.url }}" alt="photo {{ photo.id }}">
        {% endif %}

        <div class="photo-params">
          <strong>Model parameters:</strong>
          <ul>
            <li>Species: (not implemented)</li>
            <li>Date/time:
              {% if photo.date_taken %}
                {{ photo.date_taken }}{% if photo.time_taken %} {{ photo.time_taken }}{% endif %}
              {% else %}
                —
              {% endif %}
            </li>
            <li>Camera ID:
              {% if photo.camera %}
                {{ photo.camera.name }}
              {% else %}
                —
              {% endif %}
            </li>
            <li>Temperature:
              {% if photo.temperature is not None %}
                {{ photo.temperature }}&deg;C
              {% else %}
                —
              {% endif %}
            </li>
            <li>Pressure:
              {% if photo.pressure is not None %}
                {{ photo.pressure }} inHg
              {% else %}
                —
              {% endif %}
            </li>
            <li>Status:
              {% if photo.is_published %}Published{% elif photo.date_taken %}Analyzed{% else %}Uploaded{% endif %}
            </li>
          </ul>
        </div>

        <div class="card-actions">
          <form method="post" action="{% url 'wildlife:analyze_photo' photo.id %}">
            {% csrf_token %}
            <button class="btn" type="submit">Analyze</button>
          </form>

          {% if photo.date_taken and photo.time_taken and photo.temperature is not None and photo.pressure is not None and not photo.is_published %}
            <form method="post" action="{% url 'wildlife:publish_photo' photo.id %}">
              {% csrf_token %}
              <button class="btn btn-primary" type="submit">Publish</button>
            </form>
          {% endif %}

          <form method="post" action="{% url 'wildlife:delete_photo_staging' photo.id %}">
          {% csrf_token %}
            <button class="btn" type="submit"
              onclick="return confirm('Delete this unpublished photo? This cannot be undone.');">
              Delete
            </button>
          </form>

        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No uploads yet.</p>
{% endif %}

{% endblock %}
