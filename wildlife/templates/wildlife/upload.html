{% extends "wildlife/base.html" %}

{% block title %}Upload Photos{% endblock %}

{% block content %}
<h1>Staging Area (Unpublished Photos)</h1>

<p style="color:#666; margin-bottom:16px;">
  Upload new photos or help your team analyze and prepare images for publishing.
</p>

{% if error %}
  <div style="background:#ffecec; border:1px solid #f5aca6; padding:10px; margin-bottom:14px; border-radius:6px;">
    {{ error }}
  </div>
{% endif %}

<!-- Upload form -->
<form id="upload-form"
      method="post"
      enctype="multipart/form-data"
      style="margin-bottom:26px;">
  {% csrf_token %}

  <input id="file-input"
         type="file"
         name="images"
         multiple
         accept="image/*"
         style="display:none;">

    <!-- Optional: select a whole folder of images -->
    <input id="folder-input"
      type="file"
      name="images"
      multiple
      webkitdirectory
      directory
      style="display:none;">

  <div id="dropzone"
       style="border: 2px dashed #ccc;
              border-radius: 12px;
              padding: 36px;
              text-align: center;
              cursor: pointer;
              max-width: 900px;">
    <p style="margin:0;">
      Drag &amp; drop images here, or click to select files.
    </p>
    <p style="margin:8px 0 0 0; color:#666;">
      Or <button type="button" id="select-folder-btn" class="btn" style="padding:4px 8px;">Select a Folder</button>
    </p>
  </div>

  <div id="file-info"
       style="margin-top:14px; display:none;">
    <strong>Selected files:</strong>
    <div id="file-previews"
         style="margin-top:10px;
                display:flex;
                flex-wrap:wrap;
                gap:12px;"></div>
  </div>

  <p style="margin-top:14px;">
    <button id="upload-btn"
            class="btn btn-primary"
            type="submit"
            disabled>
      Upload Photos
    </button>
  </p>

  <!-- Progress bar (hidden until upload starts) -->
  <div id="progress-container" style="display:none; margin-top:14px;">
    <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
      <span><strong>Processing:</strong></span>
      <span id="progress-text">0/0</span>
    </div>
    <div style="background:#e0e0e0; border-radius:8px; height:24px; overflow:hidden;">
      <div id="progress-bar" 
           style="background:#2c6bed; height:100%; width:0%; transition:width 0.3s ease; display:flex; align-items:center; justify-content:center;">
        <span id="progress-percent" style="color:#fff; font-size:12px; font-weight:bold;"></span>
      </div>
    </div>
  </div>
</form>

<hr style="margin: 28px 0;">

<h2>Unpublished Photos</h2>
<p style="color:#666; margin-bottom:10px;">
  Use the Edit button on each card to open a full-page editor. Analyze before publishing.
</p>

{% if recent_photos %}
  <div style="display:flex; flex-wrap:wrap; gap:16px;">
    {% for photo in recent_photos %}
      <div class="photo-card is-clickable"
           data-photo-id="{{ photo.id }}"
           data-edit-url="{% url 'wildlife:photo_edit' photo.id %}"
           data-camera="{{ photo.camera.name|default:'' }}"
           data-date="{{ photo.date_taken|date:'Y-m-d'|default:'' }}"
           data-time="{% if photo.time_taken %}{{ photo.time_taken|time:'H:i' }}{% endif %}"
           data-temp="{% if photo.temperature is not None %}{{ photo.temperature }}{% endif %}"
           data-press="{% if photo.pressure is not None %}{{ photo.pressure }}{% endif %}">

        <div class="photo-title">
          {{ photo.image.name|default:"Photo" }}
        </div>

        {% if photo.image %}
          <img src="{{ photo.image.url }}"
               alt="photo {{ photo.id }}"
               class="photo-zoom">
        {% endif %}

        <div class="photo-params">
          <strong>Metadata:</strong>
          <ul>
            <li>
              Camera:
              <span class="meta-field" data-field="camera_name">
                {{ photo.camera.name|default:"—" }}
              </span>
            </li>
            <li>
              Date:
              <span class="meta-field" data-field="date_taken">
                {{ photo.date_taken|default:"—" }}
              </span>
              {% if photo.time_taken %}
                <span class="meta-field" data-field="time_taken">
                  {{ photo.time_taken }}
                </span>
              {% endif %}
            </li>
            <li>
              Temperature:
              <span class="meta-field" data-field="temperature">
                {% if photo.temperature is not None %}
                  {{ photo.temperature }}°C
                {% else %}
                  —
                {% endif %}
              </span>
            </li>
            <li>
              Pressure:
              <span class="meta-field" data-field="pressure">
                {% if photo.pressure is not None %}
                  {{ photo.pressure }} inHg
                {% else %}
                  —
                {% endif %}
              </span>
            </li>
            <li>
              Status:
              {% if photo.date_taken %}
                Analyzed
              {% else %}
                Uploaded
              {% endif %}
            </li>
          </ul>
        </div>

        <div class="card-actions">
          <!-- Card click navigates to edit page; explicit Edit button removed -->

          <!-- Publish -->
          {% if photo.date_taken and photo.time_taken and photo.temperature is not None and photo.pressure is not None %}
            <form method="post"
                  action="{% url 'wildlife:publish_photo' photo.id %}">
              {% csrf_token %}
              <button class="btn btn-primary" type="submit">
                Publish
              </button>
            </form>
          {% endif %}

          <!-- Delete -->
          <form method="post"
                action="{% url 'wildlife:delete_photo_staging' photo.id %}">
            {% csrf_token %}
            <button class="btn"
                    type="submit"
                    onclick="event.stopPropagation(); return confirm('Delete this unpublished photo? This cannot be undone.');">
              Delete
            </button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No unpublished photos right now.</p>
{% endif %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("file-input");
    const folderInput = document.getElementById("folder-input");
    const selectFolderBtn = document.getElementById("select-folder-btn");
    const fileInfo = document.getElementById("file-info");
    const filePreviews = document.getElementById("file-previews");
    const uploadBtn = document.getElementById("upload-btn");

    if (!dropzone || !fileInput) {
      console.error("Missing #dropzone or #file-input");
      return;
    }

    function createPreviewCard(file) {
      const card = document.createElement("div");
      card.className = "photo-card";
      card.style.width = "240px";

      const title = document.createElement("div");
      title.className = "photo-title";
      title.textContent = file.name;

      const img = document.createElement("img");
      img.className = "photo-zoom";
      img.alt = file.name;

      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = (e) => (img.src = e.target.result);
        reader.readAsDataURL(file);
      } else {
        img.style.display = "none";
      }

      card.appendChild(title);
      card.appendChild(img);
      return card;
    }

    function getAllSelectedFiles() {
      const list = [];
      if (fileInput && fileInput.files) {
        for (const f of fileInput.files) list.push(f);
      }
      if (folderInput && folderInput.files) {
        for (const f of folderInput.files) list.push(f);
      }
      return list;
    }

    function updateUI() {
      const files = getAllSelectedFiles();
      const hasFiles = files.length > 0;

      if (fileInfo) fileInfo.style.display = hasFiles ? "block" : "none";
      if (uploadBtn) uploadBtn.disabled = !hasFiles;

      if (filePreviews) {
        filePreviews.innerHTML = "";
        if (hasFiles) {
          files.forEach((f) => filePreviews.appendChild(createPreviewCard(f)));
        }
      }
    }

    // Click → open file picker
    dropzone.addEventListener("click", () => {
      fileInput.click();
    });

    // Select Folder button → open directory picker
    if (selectFolderBtn && folderInput) {
      selectFolderBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        folderInput.click();
      });
    }

    // Drag styling + allow drop
    ["dragenter", "dragover"].forEach((evt) => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.style.borderColor = "#2c6bed";
        dropzone.style.background = "#f1f5ff";
      });
    });

    ["dragleave", "drop"].forEach((evt) => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.style.borderColor = "#ccc";
        dropzone.style.background = "transparent";
      });
    });

    // Drop → set files on input
    dropzone.addEventListener("drop", (e) => {
      const dt = new DataTransfer();
      for (const file of e.dataTransfer.files) {
        dt.items.add(file);
      }
      fileInput.files = dt.files;
      updateUI();
    });

    // File picker selection → update UI
    fileInput.addEventListener("change", updateUI);
    if (folderInput) {
      folderInput.addEventListener("change", updateUI);
    }

    // Handle form submission with progress tracking
    const uploadFormElement = document.getElementById("upload-form");
    const uploadBtnElement = document.getElementById("upload-btn");
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");
    const progressPercent = document.getElementById("progress-percent");

    if (uploadFormElement) {
      uploadFormElement.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Get all selected files
        const files = [];
        if (fileInput && fileInput.files) {
          for (const f of fileInput.files) files.push(f);
        }
        if (folderInput && folderInput.files) {
          for (const f of folderInput.files) files.push(f);
        }

        if (files.length === 0) {
          alert("No files selected");
          return;
        }

        // Show progress bar
        progressContainer.style.display = "block";
        uploadBtnElement.disabled = true;
        dropzone.style.pointerEvents = "none";
        dropzone.style.opacity = "0.6";

        let processedCount = 0;
        let hasError = false;

        // Upload files one at a time to get real progress updates
        for (const file of files) {
          if (hasError) break;

          const formData = new FormData();
          formData.append("images", file);

          try {
            const response = await fetch(uploadFormElement.action || "", {
              method: "POST",
              body: formData,
              headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
              },
            });

            if (response.ok) {
              processedCount++;
              // Update progress in real-time as each file completes
              const percent = Math.round((processedCount / files.length) * 100);
              progressBar.style.width = percent + "%";
              progressPercent.textContent = percent + "%";
              progressText.textContent = `${processedCount}/${files.length}`;
            } else {
              console.error(`Failed to upload ${file.name}: ${response.statusText}`);
              hasError = true;
            }
          } catch (error) {
            console.error(`Upload error for ${file.name}:`, error);
            hasError = true;
          }
        }

        if (!hasError && processedCount === files.length) {
          // All files processed successfully
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          alert("Upload completed with errors. Check the console for details.");
          progressContainer.style.display = "none";
          uploadBtnElement.disabled = false;
          dropzone.style.pointerEvents = "auto";
          dropzone.style.opacity = "1";
        }
      });
    }
  });
  window.CAMERA_NAMES = {{ camera_names|safe }};


</script>
{% endblock %}
