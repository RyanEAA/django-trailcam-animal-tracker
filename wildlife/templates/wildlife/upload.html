{% extends "wildlife/base.html" %}

{% block title %}Upload Photos{% endblock %}

{% block content %}
<h1>Staging Area (Unpublished Photos)</h1>

<p style="color:#666; margin-bottom:16px;">
  Upload new photos or help your team analyze and prepare images for publishing.
</p>

<p style="margin-bottom:18px;">
  <a href="{% url 'wildlife:gallery' %}">&larr; Back to Gallery</a>
</p>

{% if error %}
  <div style="background:#ffecec; border:1px solid #f5aca6; padding:10px; margin-bottom:14px; border-radius:6px;">
    {{ error }}
  </div>
{% endif %}

<!-- Upload form -->
<form id="upload-form"
      method="post"
      enctype="multipart/form-data"
      style="margin-bottom:26px;">
  {% csrf_token %}

  <input id="file-input"
         type="file"
         name="images"
         multiple
         accept="image/*"
         style="display:none;">

  <div id="dropzone"
       style="border: 2px dashed #ccc;
              border-radius: 12px;
              padding: 36px;
              text-align: center;
              cursor: pointer;
              max-width: 900px;">
    <p style="margin:0;">
      Drag &amp; drop images here, or click to select files.
    </p>
  </div>

  <div id="file-info"
       style="margin-top:14px; display:none;">
    <strong>Selected files:</strong>
    <div id="file-previews"
         style="margin-top:10px;
                display:flex;
                flex-wrap:wrap;
                gap:12px;"></div>
  </div>

  <p style="margin-top:14px;">
    <button id="upload-btn"
            class="btn btn-primary"
            type="submit"
            disabled>
      Upload Photos
    </button>
  </p>
</form>

<hr style="margin: 28px 0;">

<h2>Unpublished Photos</h2>
<p style="color:#666; margin-bottom:10px;">
  Click a card to open and edit metadata. Analyze before publishing.
</p>

{% if recent_photos %}
  <div style="display:flex; flex-wrap:wrap; gap:16px;">
    {% for photo in recent_photos %}
      <div class="photo-card is-clickable"
           data-photo-id="{{ photo.id }}"
           data-camera="{{ photo.camera.name|default:'' }}"
           data-date="{{ photo.date_taken|date:'Y-m-d'|default:'' }}"
           data-time="{% if photo.time_taken %}{{ photo.time_taken|time:'H:i' }}{% endif %}"
           data-temp="{% if photo.temperature is not None %}{{ photo.temperature }}{% endif %}"
           data-press="{% if photo.pressure is not None %}{{ photo.pressure }}{% endif %}">

        <div class="photo-title">
          {{ photo.image.name|default:"Photo" }}
        </div>

        {% if photo.image %}
          <img src="{{ photo.image.url }}"
               alt="photo {{ photo.id }}"
               class="photo-zoom">
        {% endif %}

        <div class="photo-params">
          <strong>Metadata:</strong>
          <ul>
            <li>
              Camera:
              <span class="meta-field" data-field="camera_name">
                {{ photo.camera.name|default:"—" }}
              </span>
            </li>
            <li>
              Date:
              <span class="meta-field" data-field="date_taken">
                {{ photo.date_taken|default:"—" }}
              </span>
              {% if photo.time_taken %}
                <span class="meta-field" data-field="time_taken">
                  {{ photo.time_taken }}
                </span>
              {% endif %}
            </li>
            <li>
              Temperature:
              <span class="meta-field" data-field="temperature">
                {% if photo.temperature is not None %}
                  {{ photo.temperature }}°C
                {% else %}
                  —
                {% endif %}
              </span>
            </li>
            <li>
              Pressure:
              <span class="meta-field" data-field="pressure">
                {% if photo.pressure is not None %}
                  {{ photo.pressure }} inHg
                {% else %}
                  —
                {% endif %}
              </span>
            </li>
            <li>
              Status:
              {% if photo.date_taken %}
                Analyzed
              {% else %}
                Uploaded
              {% endif %}
            </li>
          </ul>
        </div>

        <div class="card-actions">
          <!-- Analyze -->
          <form method="post"
                action="{% url 'wildlife:analyze_photo' photo.id %}">
            {% csrf_token %}
            <button class="btn" type="submit">
              Analyze
            </button>
          </form>

          <!-- Publish -->
          {% if photo.date_taken and photo.time_taken and photo.temperature is not None and photo.pressure is not None %}
            <form method="post"
                  action="{% url 'wildlife:publish_photo' photo.id %}">
              {% csrf_token %}
              <button class="btn btn-primary" type="submit">
                Publish
              </button>
            </form>
          {% endif %}

          <!-- Delete -->
          <form method="post"
                action="{% url 'wildlife:delete_photo_staging' photo.id %}">
            {% csrf_token %}
            <button class="btn"
                    type="submit"
                    onclick="event.stopPropagation(); return confirm('Delete this unpublished photo? This cannot be undone.');">
              Delete
            </button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No unpublished photos right now.</p>
{% endif %}

{% endblock %}
